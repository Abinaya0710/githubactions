{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Create an EC2 instance with IAM Role (S3 access) and RDS instance connection in ap-south-1.",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "DBUsername": {
      "Description": "RDS database admin username",
      "Type": "String",
      "MinLength": "1"
    },
    "DBPassword": {
      "Description": "RDS database admin password",
      "Type": "String",
      "NoEcho": "true",
      "MinLength": "8"
    }
  },
  "Resources": {

     "PortfolioBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": "abinaya-my-portfolio-images",
        "AccessControl": "Private"
      }
     },
    "EC2InstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": ["ec2.amazonaws.com"] },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonS3FullAccess"
        ],
        "Path": "/"
      }
    },

    "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [{ "Ref": "EC2InstanceRole" }]
      }
    },

    "EC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow SSH and outbound DB traffic",
        "VpcId": "vpc-09ae7edb469b0e4f5",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },

    "RDSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access from EC2 to RDS",
        "VpcId": "vpc-09ae7edb469b0e4f5",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 3306,
            "ToPort": 3306,
            "SourceSecurityGroupId": { "Ref": "EC2SecurityGroup" }
          }
        ]
      }
    },

    "MyRDSInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": "mydbinstance",
        "AllocatedStorage": "20",
        "DBInstanceClass": "db.t3.micro",
        "Engine": "mysql",
        "MasterUsername": { "Ref": "DBUsername" },
        "MasterUserPassword": { "Ref": "DBPassword" },
        "VPCSecurityGroups": [{ "Ref": "RDSSecurityGroup" }],
        "PubliclyAccessible": true,
        "BackupRetentionPeriod": 0
      }
    },

    "EC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": "t3.micro",
        "ImageId": { "Fn::FindInMap": ["RegionMap", { "Ref": "AWS::Region" }, "AMI"] },
        "KeyName": { "Ref": "KeyName" },
        "IamInstanceProfile": { "Ref": "EC2InstanceProfile" },
        "SecurityGroupIds": [{ "Ref": "EC2SecurityGroup" }],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
     		"sudo yum update -y\n",
       		"sudo yum install -y httpd\n",
        	"sudo systemctl start httpd\n",
        	"sudo systemctl enable httpd\n",
        	"sudo mkdir -p /var/www/html/portfolio\n",
        	"cat << 'EOF' | sudo tee /var/www/html/portfolio/index.html\n",
        	"<!DOCTYPE html>\n",
        	"<html lang='en'>\n",
        	"<head>\n",
        	"  <meta charset='UTF-8'>\n",
        	"  <meta name='viewport' content='width=device-width, initial-scale=1.0'>\n",
        	"  <title>My Portfolio</title>\n",
        	"  <style>\n",
        	"    body { font-family: Arial, sans-serif; margin: 50px; background: #f4f4f4; }\n",
       		"    h1 { color: #333; }\n",
        	"    p { color: #555; }\n",
        	"  </style>\n",
        	"</head>\n",
        	"<body>\n",
        	"  <h1>Welcome to Abinaya Portfolio</h1>\n",
        	"  <p>This is a static portfolio hosted on Apache via EC2.</p>\n",
        	"  <ul>\n",
        	"    <li>EC2 Instance: Running Apache Web Server</li>\n",
        	"    <li>IAM Role: Access to S3</li>\n",
        	"    <li>RDS Instance: Ready for database connections</li>\n",
        	"    <li>CloudFormation: Automates infrastructure deployment</li>\n",
        	"  </ul>\n",
        	"</body>\n",
        	"</html>\n",
        	"EOF\n",
        	"sudo mv /var/www/html/portfolio/index.html /var/www/html/index.html\n"
              ]
            ]
          }
        }
      }
    }
  },
  "Mappings": {
    "RegionMap": {
      "ap-south-1": { "AMI": "ami-0305d3d91b9f22e84" }
    }
  },
  "Outputs": {
    "EC2InstanceId": {
      "Description": "Instance ID of the EC2 instance",
      "Value": { "Ref": "EC2Instance" }
    },
    "RDSInstanceEndpoint": {
      "Description": "Endpoint of the RDS instance",
      "Value": { "Fn::GetAtt": ["MyRDSInstance", "Endpoint.Address"] }
    }
  }
}
